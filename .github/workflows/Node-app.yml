name: Deploy

on:
  push:
    branches: main

jobs:
  Deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "$NODE_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # echo "$NODE_EC2_SSH_KEY" > ~/.ssh/aws.pem
          # sudo chmod 600 ~/.ssh/aws.pem
      
      - name: Add SSH known hosts
        run: ssh-keyscan 35.173.181.30 >> ~/.ssh/known_hosts

      - name: Build & Deploy  
        env:
            # PRIVATE_KEY: ${{ secrets.NODE_EC2_SSH_KEY }}
            HOSTNAME: ${{secrets.NODE_HOST_DNS}}
            USER_NAME: ${{secrets.NODE_USERNAME}}
            TARGET: ${{ secrets.NODE_TARGET_DIR }}
      
        run: |
           ssh -v -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@35.173.181.30
              cd /var/www/html &&
              git checkout main &&
              git fetch --all &&
              git reset --hard origin/main &&
              git pull origin main &&
              sudo npm i &&
              sudo npm run build &&
              sudo pm2 stop ./dist/hello-world.js &&
              sudo pm2 start ./dist/hello-world.js
              


# name: Node-app

# # Trigger deployment only on push to master branch
# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     name: Deploy to EC2 on master branch push
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout the files
#         uses: actions/checkout@v2

#       - name: Deploy to Server 1
#         uses: easingthemes/ssh-deploy@main
#         env:
#           SSH_PRIVATE_KEY: ${{ secrets.NODE_EC2_SSH_KEY }}
#           REMOTE_HOST: ${{ secrets.NODE_HOST_DNS }}
#           REMOTE_USER: ${{ secrets.NODE_USERNAME }}
#           TARGET: ${{ secrets.NODE_TARGET_DIR }}
      
#       - name: Restart PM2 server
#         run: |
#           sudo npm install -g pm2
#           cd /home/runner/work/node/node
#           pwd
#           ls -ll
#           sudo pm2 start hello-world.js
#           sudo pm2 list